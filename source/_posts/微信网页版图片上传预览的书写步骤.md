---
title: 微信网页版图片上传预览的书写步骤
date: 2018-09-05 18:04:35
tags:
- react
- antd-mobile
- 微信JS-SDK
categories: 
- 微信网页版
---

>微信网页版文档：https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1421141115
>引言：最近做了一个关于图片的功能，包括添加/预览/删除，这里用react的ui框架的一个标签即能实现这些功能。当然还需要调微信端的图像接口。我已经记录了下来。

### 概述
微信JS-SDK是[微信公众平台](https://mp.weixin.qq.com/cgi-bin/loginpage?t=wxm2-login&lang=zh_CN&token=)面向网页开发者提供的基于微信内的网页开发工具包。

通过使用微信JS-SDK，网页开发者可以借助使用拍照/选图/语音/位置等手机系统的能力，同时可以直接使用微信分享、扫一扫、卡券、支付等微信特有的能力，为微信用户提供更优质的网页体验。

### 使用步骤
#### 1. 绑定域名
#### 2. 引入js文件 `http://res.wx.qq.com/open/js/jweixin-1.4.0.js`
#### 3. 注入权限验证配置
所有需要使用JS-SDK的页面必须先注入配置信息，否则无法调用。
```
wx.config({
    debug: true, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
    appId: '', // 必填，公众号的唯一标识
    timestamp: , // 必填，生成签名的时间戳
    nonceStr: '', // 必填，生成签名的随机串
    signature: '',// 必填，签名
    jsApiList: [] // 必填，需要使用的JS接口列表
});

eg: 需要的JS接口列表
jsApiList:['checkJsApi',
          'chooseImage',
          'uploadImage',
          'getLocalImgData',
          'onMenuShareAppMessage',
          ]
```
#### 4. 通过ready接口处理成功验证
```
wx.ready(function(){
    // config信息验证后会执行ready方法，所有接口调用都必须在config接口获得结果之后，config是一个客户端的异步操作，所以如果需要在页面加载时就调用相关接口，则须把相关接口放在ready函数中调用来确保正确执行。对于用户触发时才调用的接口，则可以直接调用，不需要放在ready函数中。
});

eg: 开启分享功能
window.wx.ready(() => {
  // 分享给朋友
  window.wx.onMenuShareAppMessage({
    title,
    desc,
    link,
    imgUrl,
    type: '',
    dataUrl: '',
  });
});
```
#### 5.通过error接口处理失败验证
```
wx.error(function(res){
    // config信息验证失败会执行error函数，如签名过期导致验证失败，具体错误信息可以打开config的debug模式查看，也可以在返回的res参数中查看，对于SPA可以在这里更新签名。
});
```
config配置成功后，就可以调用接口了。
```
import { ImagePicker} from 'antd-mobile';

<ImagePicker
  length="4"
  files={files}
  // 删除
  onChange={this.onChange}
  // 点击图片预览
  onImageClick={this.onImageClick}
  selectable={files.length < 4}
  // 增加图片
  onAddImageClick={this.onAddImageClick}
/>
```
```
// 增加图片：从本地或手机相册选择
wx.chooseImage({
  count: 1, // 最多选择几张
  sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
  sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
  success: function (res) {
  var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
  }
});

// 选择图片时在此处出现了IOS兼容性问题
此接口仅在 iOS WKWebview 下提供，用于兼容 iOS WKWebview 不支持 localId 直接显示图片的问题
  wx.getLocalImgData({
  localId: '', // 图片的localID
  success: function (res) {
  var localData = res.localData; // localData是图片的base64数据，可以用img标签显示
  }
  });
`页面如何判断当前使用的webview内核：
在页面中可通过微信注入的window.wxjs_is_wkwebview变量判断当前使用的webview内核。 iOS微信6.5.3及其之后的版本 window.wxjs_is_wkwebview 为true时是使用WKWebview，为 false或者 “undefine”时是 UIWebview 。`
```
```
// 预览图片
  wx.previewImage({
  current: '', // 当前显示图片的http链接
  urls: [] // 需要预览的图片http链接列表
  });
```

记录我的代码：
```
// https.js
// 微信jssdk签名
export function wxShare(options) {
  const url = window.location.href.replace(/&/g, '@@@');
  axios
    .get('weixin/api/v1/weixin/callback/showdata', {
      params: {
        url: url.split('#')[0],
      },
    })
    .then(res => {
      const { nonceStr, timestamp, signature, appid } = res.data.data;
      const defaultLink = window.location.href;
      const {
        title = '',
        desc = '',
        link = defaultLink,
        imgUrl = '',
      } = options;

      window.wx.config({
        debug: false,
        appId: appid,
        timestamp,
        nonceStr,
        signature,
        jsApiList: [
          'checkJsApi',
          'chooseImage',
          'uploadImage',
          'getLocalImgData',
          'onMenuShareAppMessage',
        ],
      });
      window.wx.ready(() => {
        // 分享给朋友
        window.wx.onMenuShareAppMessage({
          title,
          desc,
          link,
          imgUrl,
          type: '',
          dataUrl: '',
        });
      });
    });
}
```
```
// index.jsx
import React from 'react';
import {
  List,
  TextareaItem,
  Button,
  WingBlank,
  ImagePicker,
} from 'antd-mobile';
import { createForm } from 'rc-form';
import styled from 'styled-components';
import { rem } from '@/utils/utils';
import { wxShare } from '@/api/http';

const data = [
  {
    url: 'https://zos.alipayobjects.com/rmsportal/PZUUCKTRIHWiZSY.jpeg',
    id: '0',
  },
];
class Feedbackkk extends React.Component {
  state = {
    files: data,
  };
  componentDidMount() {
    wxShare({
      title: '反馈',
    });
  }
  //点击图片预览
  onImageClick = (index, fs) => {
    // console.log(index, fs); 索引 图片数组
    let urls = [];
    fs.forEach(item => {
      urls.push(item.url);
    });
    window.wx.previewImage({
      current: fs[index].url, // 当前显示图片的http链接
      urls: urls, // 需要预览的图片http链接列表
    });
  };
  // 控制删除
  onChange = (files, type, index) => {
    // console.log(files, type, index); 图片数组 "remove" 删除的索引
    this.setState({
      files,
    });
  };
  // 增加图片
  onAddImageClick = e => {
    e.preventDefault();

    let isWk = false;
    if (window.wxjs_is_wkwebview) {
      isWk = true;
    }
    window.wx.chooseImage({
      count: 4, // 默认9，最多选择几张
      sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
      sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
      success: res => {
        console.log(res);
        // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
        let localIds = res.localIds;
        localIds.forEach((item, index) => {
          if (isWk) {
            window.wx.getLocalImgData({
              localId: item, // 图片的localID
              success: res => {
                let localData = res.localData;
                // 展示选中图片
                this.setState({
                  files: this.state.files.concat({
                    url: localData,
                    id: this.state.files.length + index,
                  }),
                }); // localData是图片的base64数据，可以用img标签显示
              },
            });
          } else {
            // 展示选中图片
            this.setState({
              files: this.state.files.concat({
                url: item,
                id: this.state.files.length + index,
              }),
            });
          }
          // 上传图片
          // window.wx.uploadImage({
          //   localId: res.localIds[0], // 需要上传的图片的本地ID，由chooseImage接口获得
          //   isShowProgressTips: 0, // 默认为1，显示进度提示
          //   success: pic => {
          //     // this.uploadImage(pic.serverId).then(resp => {
          //     //   if (resp.data) {
          //     //     Toast('上传成功');
          //     //   } else {
          //     //     Toast('上传失败');
          //     //   }
          //     // });
          //   },
          // });
        });
      },
    });
  };

  render() {
    const { getFieldProps } = this.props.form;
    const { files } = this.state;
    return (
      <div>
        <Li>
          <Texta
            {...getFieldProps('count', {
              // initialValue: '描述您遇到的问题或建议',
            })}
            rows={4}
            count={200}
            placeholder="描述您遇到的问题或建议"
          />
        </Li>
        <Screenshots>
          <SsText>相关截图</SsText>
          <SsCount>0/4</SsCount>
        </Screenshots>
        <ImgSel>
          <ImagePicker
            length="4"
            files={files}
            onChange={this.onChange}
            onImageClick={this.onImageClick}
            selectable={files.length < 4}
            onAddImageClick={this.onAddImageClick}
          />
        </ImgSel>
        <WingBlank>
          <Btn type="warning">提交</Btn>
        </WingBlank>
      </div>
    );
  }
}
const Feedback = createForm()(Feedbackkk);
export default Feedback;

const Li = styled(List)`
  padding: ${rem('0 15px')};
  background: #fff;
  .am-list-item.am-textarea-item {
    padding: 0 !important;
  }
`;
const Texta = styled(TextareaItem)`
  .am-textarea-control textarea {
    font-size: ${rem('14px')};
  }
  .am-textarea-count {
    color: #999;
    transform: translateX(${rem('4px')});
    margin-bottom: ${rem('10px')};
  }
  .am-textarea-count span {
    color: #999999;
  }
`;
const ImgSel = styled.div`
  background: #fff;
  .am-image-picker-list {
    padding: ${rem('0 15px 23px 15px')};
  }
`;
const Screenshots = styled.div`
  background: #fff;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: ${rem('12px 15px 8px 15px')};
`;
const SsText = styled.div`
  font-size: ${rem('16px')};
  color: #595959;
`;
const SsCount = styled.div`
  font-size: ${rem('14px')};
  color: #999999;
`;
const Btn = styled(Button)`
  span {
    font-size: ${rem('18px')};
  }
`;
const III = styled.img`
  width: 80px;
  height: 80px;
`;
const CCC = styled.img`
  width: 80px;
  height: 80px;
`;
const Add = styled.div`
  width: 80px;
  height: 80px;
  border: 1px solid #000;
`;

```



